# Uniq Collector

<!-- | Основные технологии | Node.js, TypeScript, node-fetch, JSDOM |
| --- | --- |
| зависимости | Mongo | -->

## Ожидаемое поведение

Реализует цепочку обработчиков (сбор данных о группах, сбор данных расписаний, формирование списка аудиторий, преподавателей). Каждый из них принимает на вход данные и сохраняет результат в БД. При этом на первом этапе исходные данные сводятся к передаче конфигурации запуска, а все последующие обработчики обращаются в базу к результатам выполнения ранее отработавших обработчиков. несмотря на возможность параллельного выполнения некоторых обработчиков, все обработчики запускаются последовательно для удобства отслеживания текущего прогресса и отладки в силу отсутствия строгих треьований к суммарному времени выполнения цепочки.

Цепочка обработчиков запускается при старте контейнера и раз в некоторое фиксированное в конфигурации время.

Система имеет версионность данных и архив расписания для возможного использования в будущем. Каждый новый успешный запуск цепочки обработчиков приводит к созданию новой БД с результатами парсинга расписаняи и

При новом запуске цепочки контекст переключается на вновь созданную базу c названием “черновик”. После успешного завершения сбора данных, название меняется на время завершения сбора.

В случае падения сервиса в процессе формирования черновкиа при повторном запуске сервиса выполнения цепочки начинается заново, но все обработчики должны быть реализованы идемпотентно. Для удобства, каждый обработчки обладает следующими свойствами:

1. идемпотентности (перед началом выполнения кода, проверяет БД на наличие результатов)
2. результативностью (то есть по итогу его успешного выполнения должна быть создана коллекция (или несколько с учётом п.4) с данными в БД)
3. иммутабельности (то есть отсутствия сайд-эффектов, затрагивающих коллекции данных, являющиеся результатом работы других обработчиков)
4. транзакционности (невозможна ситуация при которой результаты обработчика частично помещены в БД. Реализуется путём применения транзакций при необходимости создания нескольких коллекций)

## Технический проект

Структура файлов и папок примерно следующая

- index.ts
- handlers
  - first.handler.ts
  - second.handler.ts
- services
  - first.service.ts
  - second.service.ts

Все модели и функции-утилиты, не привязанные к контексту данного сервиса и его архитектуре, должны быть вынесены в shared сервис.

На верхнем уровне код сервиса выглядит примерно так. Каждый сервис является верхним уровнем дерева зависимостей, реализуемого через DI при помощи TSyringe.

```tsx
const handlers = [
  FirstHandler,
  SecondHandler,
];

async function main() {
  for (const Handler of handlers) {
    const handler = container.resolve(Handler);
    await handler.execute();
  }
  const mongo = container.resolve(MongoService);
  mongo.flush() // Renames database from 'draft' to 2022-06-18T16:08:55.235Z
}
```

Сервис базы данных не является агностичным по отношению к домену. Он знает о возможных именах коллекций, таким образом гарантируя соответствие названий для одной и той же коллекции в разных обработчиках.

```tsx
/**
 * Here is the place to register a new collection and provide a type for its documents
 */
interface NameToDocumentMap {
  'lessons': Lesson,
  'lessons-raw': LessonRaw
}

export type CollectionName = keyof NameToDocumentMap;

abstract class MongoService {
  public abstract collection<TName extends CollectionName>(
    name: TName
  ): Promise<Collection<NameToDocumentMap[TName]>>;
 public abstract flush();
 public abstract dispose();
}
```

Помимо `MongoService` в системе есть ещё ряд сервисов. К ним относятся:

- GroupsLoaderService (можно отнаследовать от abstract LoaderService с утилитами)
- LessonsRawLoaderService (сохраняет максимально сырые данные без предобработки. Так потом можно расследвоать проблемы, возникшие при анализе пар)
- LessonsMergeService (группирует массив сырых данных)
- LessonsAnalyserService (ставит теги, приводит к единообразию)
- ParserService (Вероятно, стоит разбить на отдельные парсеры для разных задач)
- TeachersExtractorService (эту логику стоит сделать портируемой)
- ClassroomsExtractorService (эту логику стоит сделать портируемой)
